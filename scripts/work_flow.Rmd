---
title: "work_flow"
author: "blind"
date: "2024-04-15"
output: html_document
---

```{r setup, include=FALSE}
library(purrr)
library(tidyr)
library(dplyr)
library(tidyverse)
library(ggplot2)
library(psycho)
library(readxl)
library(GGally)
library(conflicted)
library(performance)
```

```{r}
path<-"../../ppcc_iflu_data/data_exp_170005-v9"
list.files(path)

read_csvs_with_pattern <- function(path, pattern) {
  files <- list.files(path, pattern = pattern, full.names = TRUE)
  data_list <- map(files, read.csv)
  combined_data <- bind_rows(data_list)
  colnames(combined_data)<-tolower(colnames(combined_data))
  return(combined_data)
}

read_xls_with_pattern <- function(path, pattern) {
  files <- list.files(path, pattern = pattern, full.names = TRUE)
  data_list <- map(files, read_excel)
  combined_data <- bind_rows(data_list)
  colnames(combined_data)<-tolower(colnames(combined_data))
  return(combined_data)
}

pattern="11wd"
s_exp1 <- read_csvs_with_pattern(path, paste(pattern,".*\\.csv",sep=""))
s_exp1_et <- read_xls_with_pattern(file.path(path,"uploads/"), pattern)

pattern="vg7n"
s_exp2 <- read_csvs_with_pattern(path, paste(pattern,".*\\.csv",sep=""))
s_exp2_et <- read_xls_with_pattern(file.path(path,"uploads/"), pattern)


pattern="1f8j"
digit_span <- read_csvs_with_pattern(path, paste(pattern,".*\\.csv",sep=""))

pattern="7oyj|9uw1|wxw8|qa8d"
battery <- read_csvs_with_pattern(path, paste(pattern,".*\\.csv",sep=""))

pattern="rsao"
lextale <- read_csvs_with_pattern(path, paste(pattern,".*\\.csv",sep=""))

pattern="m24c"
italian_lextale <- read_csvs_with_pattern(path, paste(pattern,".*\\.csv",sep=""))

pattern="3nvp"
autism <- read_csvs_with_pattern(path, paste(pattern,".*\\.csv",sep=""))


removal <- data.frame(task = character(), 
                      value = numeric(), 
                      stringsAsFactors = FALSE)
```

```{r}
battery_tidy<-battery%>%
  select(participant.private.id,tree.node.key,task.name,screen.name,screen.number,display,reaction.time,response,sound1,sound2,base1,base2,same)%>%
  filter(display=="block" &screen.name == "Screen 3")%>%
  mutate(responses=case_when(response == "'z'"~1,
                             response == "'m'"~0),
         correct=if_else(responses==same,1,0),
         difference=abs(base1-base2))

battery_tidy%>%ggplot(aes(x=reaction.time))+geom_histogram()+facet_wrap(participant.private.id~.)

mad_standard=3

battery_cleaned<-battery_tidy%>%
  #group_by(participant.private.id)%>%
  dplyr::filter(reaction.time>200)%>%
  mutate(log_rt=sqrt(reaction.time))%>%
  mutate(display_medians = median(log_rt),
         abs_distance = abs(display_medians-log_rt),
         mean_distance = mean(abs_distance),
         upper_mad = display_medians+(mean_distance*mad_standard),
         lower_mad = display_medians-(mean_distance*mad_standard))%>%
  group_by(participant.private.id)%>%
  mutate(participants_medians = median(log_rt))%>%
  dplyr::filter(log_rt<upper_mad &log_rt>lower_mad)


removal[nrow(removal) + 1, ] <- c("battery removal", 
                                  nrow(battery_tidy) - nrow(battery_cleaned))

battery_cleaned%>%ggplot(aes(x=log_rt))+
  geom_histogram()+
  geom_point(aes(x=upper_mad,y=0),color="red")+
  geom_point(aes(x=lower_mad,y=0),color="blue")+
  facet_wrap(participant.private.id~.)

battery_cleaned%>%ggplot(aes(x=factor(participant.private.id),y=participants_medians))+
  geom_point()+
  geom_point(aes(y=upper_mad,x=factor(participant.private.id)),color="red")+
  geom_point(aes(y=lower_mad,x=factor(participant.private.id)),color="blue")

battery_cleaned_part_agg<-battery_cleaned%>%
  group_by(participant.private.id)%>%
summarise(score=mean(correct))%>%
  ungroup()%>%
    mutate(medians = median(score),
           abs_distance = abs(medians-score),
           mean_distance = mean(abs_distance),
           upper_mad = medians+(mean_distance*mad_standard),
           lower_mad = medians-(mean_distance*mad_standard))

battery_cleaned_part_agg%>%
  ggplot(aes(x=factor(participant.private.id),y=score))+
  geom_point()+
  geom_point(aes(x=factor(participant.private.id),y=upper_mad),color="red")+
  geom_point(aes(x=factor(participant.private.id),y=lower_mad),color="red")+
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))

battery_cleaned_part_agg_keep<-battery_cleaned_part_agg%>%
  filter(score<upper_mad & score>lower_mad)

battery_cleaned_item_agg<-battery_cleaned%>%
  group_by(difference,participant.private.id)%>%
summarise(score=mean(correct))%>%
  ungroup()%>%
    mutate(medians = median(score),
           abs_distance = abs(medians-score),
           mean_distance = mean(abs_distance),
           upper_mad = medians+(mean_distance*mad_standard),
           lower_mad = medians-(mean_distance*mad_standard))

battery_cleaned_item_agg%>%
  ggplot(aes(x=factor(difference),y=score))+
  geom_boxplot()+
  geom_point()+
  geom_point(aes(x=factor(difference),y=upper_mad),color="red")+
  geom_point(aes(x=factor(difference),y=lower_mad),color="red")+
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))

#battery_cleaned<-battery_cleaned%>%filter(difference<35)
```
```{r}
battery_agg2<-battery_cleaned%>%
  group_by(participant.private.id, task.name) %>%
  summarize(score=mean(correct))

battery_agg2%>%ggplot(aes(x=task.name,y=score,color=factor(task.name)))+
  geom_boxplot()+
  geom_jitter()+
  theme_minimal()

battery_agg<-battery_cleaned%>%
  mutate(
    hit = if_else(same == 1 & responses == 1L, 1L, 0L),
    f_a = if_else(same == 0 & responses == 1L, 1L, 0L),
    miss = if_else(same == 0 & responses == 0L, 1L, 0L),
    c_r = if_else(same == 1 & responses == 0L, 1L, 0L))%>%
  group_by(participant.private.id, task.name) %>%
  summarize(
    score=mean(correct)+.5,
    hit_count = sum(hit)+.5,
    f_a_count = sum(f_a)+.5,
    miss_count = sum(miss)+.5,
    c_r_count = sum(c_r)+.5,
    .groups = 'drop')%>%
  mutate(
    dprime = dprime(hit_count, 
                             f_a_count, 
                             hit_count + miss_count, 
                             f_a_count + c_r_count)$dprime,
    c = dprime(hit_count, 
                        f_a_count, 
                        hit_count + miss_count, 
                        f_a_count + c_r_count)$c)%>%
  select(participant.private.id, task.name, dprime, c)


battery_agg%>%ggplot(aes(x=factor(task.name),y=dprime,color=factor(task.name),alpha=.4))+
  geom_line(aes(group=factor(participant.private.id)),color="black")+
  geom_violin()+
  geom_boxplot(width=.5)+
  geom_point()+
  theme_minimal()

battery_agg%>%ggplot(aes(x=c,y=dprime,color=factor(task.name)))+
  geom_point()+
  theme_minimal()+
  facet_grid(.~factor(task.name))

battery_agg_wider<-battery_agg%>%
  pivot_wider(names_from = task.name,values_from = c(dprime:c))

battery_agg_wider_simp<-battery_agg_wider
ggpairs(battery_agg_wider_simp%>%select(!participant.private.id))
```

```{r}
digit_tidy<-digit_span%>%
  select(participant.private.id,tree.node.key,task.name,
         target,response,length,correct.,total.correct)%>%
  filter(correct.==1)%>%
  group_by(participant.private.id)%>%
  mutate(length=as.numeric(length))%>%
  summarize(max_working_memory=max(length),
         min_working_memory=min(length),
         mean_working_memory=mean(length),
         max_correct=max(total.correct))

digit_tidy%>%
  ggplot(aes(x=1,y=max_correct,color=factor(max_working_memory)))+
  geom_jitter()

digit_cleaned<-digit_tidy%>%
  ungroup()%>%
  mutate(display_medians = median(max_correct),
         abs_distance = abs(display_medians-mean_working_memory),
         mean_distance = mean(abs_distance),
         upper_mad = display_medians+(mean_distance*mad_standard),
         lower_mad = display_medians-(mean_distance*mad_standard))%>%
  filter(max_correct<upper_mad &max_correct>lower_mad)

digit_cleaned%>%
  ggplot(aes(x=mean_working_memory))+
  geom_histogram()

digit_cleaned%>%
  ggplot(aes(x=1,y=mean_working_memory,color=factor(max_working_memory)))+
  geom_jitter()

removal[nrow(removal) + 1, ] <- c("digit_span_participant", 
                                  nrow(digit_tidy) - nrow(digit_cleaned))

digit_cleaned_simp<-digit_cleaned%>%select(participant.private.id,mean_working_memory)
```

```{r}
lextale_tidy<-lextale%>%
  select(participant.private.id,screen.name,zone.type,reaction.time,correct)%>%
  filter(zone.type=="response_keyboard")%>%
  filter(reaction.time>250)

lextale_tidy%>%ggplot(aes(x=reaction.time))+geom_histogram()

lextale_agg<-lextale_tidy%>%
  group_by(participant.private.id)%>%
  summarize(lextale_score=mean(correct))

lextale_agg_cleaned<-lextale_agg%>%
  ungroup()%>%
  mutate(medians = median(lextale_score),
         abs_distance = abs(medians-lextale_score),
         mean_distance = mean(abs_distance),
         upper_mad = medians+(mean_distance*mad_standard),
         lower_mad = medians-(mean_distance*mad_standard))%>%
  filter(lextale_score<upper_mad &lextale_score>lower_mad)


lextale_agg_cleaned%>%ggplot(aes(x=lextale_score))+
  geom_histogram()


removal[nrow(removal) + 1, ] <- c("lextale_agg_participant", 
                                  nrow(lextale_agg) - nrow(lextale_agg_cleaned))

lextale_agg_cleaned_simp<-lextale_agg_cleaned%>%select(lextale_score,participant.private.id)
```
```{r}

italian_lextale_tidy<-italian_lextale%>%
  select(participant.private.id,screen.name,zone.type,reaction.time,correct)%>%
  filter(zone.type=="response_keyboard")%>%
  filter(reaction.time>250)

italian_lextale_tidy%>%ggplot(aes(x=reaction.time))+geom_histogram()

italian_lextale_agg<-italian_lextale_tidy%>%
  group_by(participant.private.id)%>%
  summarize(italian_lextale_score=mean(correct))

italian_lextale_agg_cleaned<-italian_lextale_agg%>%
  ungroup()%>%
  mutate(medians = median(italian_lextale_score),
         abs_distance = abs(medians-italian_lextale_score),
         mean_distance = mean(abs_distance),
         upper_mad = medians+(mean_distance*mad_standard),
         lower_mad = medians-(mean_distance*mad_standard))%>%
  filter(italian_lextale_score<upper_mad &italian_lextale_score>lower_mad)


italian_lextale_agg_cleaned%>%ggplot(aes(x=italian_lextale_score))+
  geom_histogram()


removal[nrow(removal) + 1, ] <- c("italian_lextale_agg_participant", 
                                  nrow(italian_lextale_agg) - nrow(italian_lextale_agg_cleaned))

italian_lextale_agg_cleaned_simp<-italian_lextale_agg_cleaned%>%select(italian_lextale_score,participant.private.id)
```

```{r}
autism_tidy<-autism%>%
  select(participant.private.id,question.key,response)%>%
  filter(str_detect(question.key, "quantised"))%>%
  mutate(response=as.numeric(response))


agree<-c(1, 2, 4, 5, 6, 7, 9, 12, 13, 16, 18, 19, 20, 21, 
         22, 23, 26, 33, 35, 39, 41,42, 43, 45, 46)
disagree<-c(3, 8, 10, 11, 14, 15, 17, 24, 25, 27, 28, 29, 
            30, 31, 32,34, 36, 37, 38, 40, 44, 47, 48, 49, 50)
agr_key<-c("1","2")
dis_key<-c("3","4")

autism_cleaned<-autism_tidy%>%
  mutate(key_response = str_replace_all(question.key, "AQ", ""))%>%
  mutate(key_response = str_replace_all(key_response, "-quantised", ""))%>%
  mutate(points=case_when(key_response%in%agree & response %in% agr_key~1,
                          key_response%in%agree & response %in% dis_key~0,
                          key_response%in%disagree & response %in% dis_key~1,
                          key_response%in%disagree & response %in% agr_key~0))%>%
  group_by(participant.private.id)%>%
  summarize(autism_score=mean(points))

autism_cleaned%>%ggplot(aes(x=autism_score))+geom_histogram()
```

```{r}
s_exp1_cleaned<-s_exp1%>%
  select(participant.private.id,spreadsheet.row,response,real_1_distractor_0,zone.type,display,audio,
         q1_image,q2_image,q3_image,q4_image,
         id,grouping_id,sorting,audio)%>%
  filter(zone.type=="response_button_image")%>%
  mutate(audio=tolower(audio),
         word_play = str_remove(str_extract(audio, "^[^_]+"), "\\.wav"),
         word_play_start = substr(word_play, 1, 3),
         stress_play = str_remove(str_extract(audio, "(?<=_)[^_]+"), "\\.wav"),
         response_word = str_extract(response, "(?<=\\d)[a-zA-Z]+(?=\\.jpeg)"),
         response_thing = str_extract(response, "(?<=\\D)\\d{2}(?=[a-zA-Z]+\\.jpeg)"),
         correct=if_else(response_word==word_play,1,0))%>%
  mutate(stress_play=if_else(stress_play=="p","Penultimate","Anti-penultimate"),
         q1_word= str_extract(q1_image, "(?<=\\d)[a-zA-Z]+(?=\\.jpeg)"),
         q2_word= str_extract(q2_image, "(?<=\\d)[a-zA-Z]+(?=\\.jpeg)"),
         q3_word= str_extract(q3_image, "(?<=\\d)[a-zA-Z]+(?=\\.jpeg)"),
         q4_word= str_extract(q4_image, "(?<=\\d)[a-zA-Z]+(?=\\.jpeg)"))%>%
 mutate(target_quantile=case_when(q1_word==word_play~1,
                                 q2_word==word_play~2,
                                 q3_word==word_play~3,
                                 q4_word==word_play~4),
       competitor_quantile = case_when(
      q1_word != word_play & str_detect(q1_word,word_play_start) ~ 1,
      q2_word != word_play & str_detect(q2_word,word_play_start) ~ 2,
      q3_word != word_play & str_detect(q3_word,word_play_start) ~ 3,
      q4_word != word_play & str_detect(q4_word,word_play_start) ~ 4))%>%
  rowwise() %>%
  mutate(distractor_1_quantile = {
    possible_values <- setdiff(1:4, c(target_quantile, competitor_quantile))
    sample(possible_values, 1)
  })%>%
  mutate(distractor_2_quantile = 10-sum(distractor_1_quantile,target_quantile,competitor_quantile))

s_exp1_cleaned<-s_exp1_cleaned%>%
  mutate(target = case_when(target_quantile == 1 ~ q1_word,
                            target_quantile == 2 ~ q2_word,
                            target_quantile == 3 ~ q3_word,
                            target_quantile == 4 ~ q4_word))
g<-4
g
```

```{r}
item_agg<-s_exp1_cleaned%>%group_by(word_play)%>%
  summarise(score=mean(correct))%>%
  ungroup()%>%
  mutate(medians = median(score),
         abs_distance = abs(medians-score),
         mean_distance = mean(abs_distance),
         upper_mad = medians+(mean_distance*mad_standard),
         lower_mad = medians-(mean_distance*mad_standard))

item_agg%>%
  ggplot(aes(x=factor(word_play),y=score))+
  geom_point()+
  geom_point(aes(x=factor(word_play),y=upper_mad),color="red")+
  geom_point(aes(x=factor(word_play),y=lower_mad),color="red")+
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))

item_agg_keep<-item_agg%>%
  filter(score<upper_mad & score>lower_mad)

removal[nrow(removal) + 1, ] <- c("exp1_item_removed", 
                                  length(unique(item_agg$word_play)) - length(unique(item_agg_keep$word_play)))

part_agg<-s_exp1_cleaned%>%group_by(participant.private.id)%>%
  summarise(score=mean(correct))%>%
  ungroup()%>%
    mutate(medians = median(score),
           abs_distance = abs(medians-score),
           mean_distance = mean(abs_distance),
           upper_mad = medians+(mean_distance*mad_standard),
           lower_mad = medians-(mean_distance*mad_standard))

part_agg%>%
  ggplot(aes(x=factor(participant.private.id),y=score))+
  geom_point()+
  geom_point(aes(x=factor(participant.private.id),y=upper_mad),color="red")+
  geom_point(aes(x=factor(participant.private.id),y=lower_mad),color="red")+
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))

part_agg_keep<-part_agg%>%
  filter(score<upper_mad & score>lower_mad)

removal[nrow(removal) + 1, ] <- c("exp1_part_removed", 
                                  length(unique(part_agg$participant.private.id)) - length(unique(part_agg_keep$participant.private.id)))

#s_exp1_cleaned<-s_exp1_cleaned%>%filter(participant.private.id%in%part_agg_keep$participant.private.id)
#s_exp1_cleaned<-s_exp1_cleaned%>%filter(word_play%in%item_agg_keep$word_play)

length(unique(s_exp1_cleaned$participant.private.id))
length(unique(s_exp1_cleaned$word_play))

list_o_word<-c('canapa','candido','celebre','codice','comico','eremo','estero','federa','forbice','fragola','impeto','lattice','loculo','macabro','mastice','missile','monito','panico','protesi','remora','salice','senape','tonaca','zigomo','canale','candito','celeste','codino','comizio','erede','esteta','fedele','forbito','fragore','impero','lattina','locusta','macaco','mastino','missiva','monile','panino','protesta','remoto','saliva','senato','tonale','zigote')

s_exp1_cleaned<-s_exp1_cleaned%>%
  filter(correct==1)%>%
  filter(word_play%in%list_o_word)

prac<-s_exp1_cleaned%>%ungroup()%>%group_by(real_1_distractor_0,stress_play,word_play)%>%count()
```

```{r}
s_exp1_et_cleaned<-s_exp1_et%>%
  select(participant_id,spreadsheet_row,type,time_stamp,
         time_elapsed,x_pred_normalised,y_pred_normalised,face_conf)%>%
  mutate(participant.private.id=participant_id,
         spreadsheet.row=spreadsheet_row)%>%
  select(!c(participant_id,spreadsheet_row))%>%
  filter(type=="prediction")
  
origin<-c(0,0)
s_exp1_data_all <- s_exp1_et_cleaned %>%
  left_join(s_exp1_cleaned)%>%
  na.omit()%>%
  filter(face_conf>.5)%>%
  mutate(x_pred_normalised=x_pred_normalised-.5,
         y_pred_normalised=y_pred_normalised-.5)%>%
  filter(x_pred_normalised<1&x_pred_normalised>-1)%>%
  filter(y_pred_normalised<1&y_pred_normalised>-1)%>%
  mutate(current_quadrant = case_when(
            x_pred_normalised < origin[1] & y_pred_normalised > origin[2] ~ q1,
            x_pred_normalised > origin[1] & y_pred_normalised > origin[2] ~ q2,
            x_pred_normalised < origin[1] & y_pred_normalised < origin[2] ~ q3,
            x_pred_normalised > origin[1] & y_pred_normalised < origin[2] ~ q4))%>%
  mutate(target_looks=if_else(current_quadrant==target,1,0),
         competitor_looks=if_else(current_quadrant==competitor,1,0),
         dist1_looks=if_else(current_quadrant==dist_1,1,0),
         dist2_looks=if_else(current_quadrant==dist_2,1,0))%>%
  group_by(participant.private.id,spreadsheet.row,stress_play)%>%
  mutate(time=time_stamp-min(time_stamp),
         time_rounded = round(time / 50) * 50)%>%
  mutate(time_rounded=time_rounded-1000)%>%
  mutate(time_rounded=time_rounded-200)%>%
  filter(time_rounded<1000&time_rounded>0)

View(s_exp1_data_all)  
ets_exp1_all_agg<-s_exp1_data_all%>%
  group_by(stress_play,time_rounded)%>%
  summarise(mean_target_looks=mean(target_looks),
            mean_competitor_looks=mean(competitor_looks),
            mean_dist1_looks=mean(dist1_looks),
            mean_dist2_looks=mean(dist2_looks))%>%
  ungroup()%>%
  pivot_longer(cols=c(mean_target_looks:mean_dist2_looks),names_to = "names",values_to="values")
  

ets_exp1_all_agg%>%
  ggplot(aes(x=time_rounded,y=values,color=names))+
  geom_point()+
  geom_smooth()+
  facet_grid(stress_play~.)

ets_exp1_all_agg_part<-s_exp1_data_all%>%
  group_by(stress_play,participant.private.id)%>%
  summarise(mean_target_looks=mean(target_looks),
            mean_competitor_looks=mean(competitor_looks),
            mean_dist1_looks=mean(dist1_looks),
            mean_dist2_looks=mean(dist2_looks))%>%
  ungroup()%>%
  pivot_longer(cols=c(mean_target_looks:mean_dist2_looks),names_to = "names",values_to="values")
  

ets_exp1_all_agg_part%>%
  ggplot(aes(x=factor(participant.private.id),y=values,color=names))+
  geom_point()+
  geom_smooth()+
  facet_grid(stress_play~.)+
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))

```
```{r}
ets_exp1_all_agg_part_wider<-ets_exp1_all_agg_part%>%
  pivot_wider(names_from = names,values_from = values)%>%
  mutate(proportion_o_looks=mean_target_looks-mean_competitor_looks)%>%
  left_join(battery_agg_wider_simp)%>%
  left_join(digit_cleaned_simp)%>%
  left_join(lextale_agg_cleaned_simp)%>%
  left_join(italian_lextale_agg_cleaned_simp)%>%
  left_join(autism_cleaned)

ets_exp1_all_agg_part_wider%>%
  ggplot(aes(x=stress_play,y=proportion_o_looks,color=stress_play))+
  geom_boxplot()+
  geom_jitter()+
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))
full_data_exp1<-ets_exp1_all_agg_part_wider%>%select(!c(participant.private.id,c_battery_up_dur:c_battery_up_risetime,mean_target_looks:mean_dist2_looks))
ggpairs(full_data_exp1)
```

```{r message=FALSE, warning=FALSE, paged.print=FALSE}
#installed.packages("leaps")
#installed.packages("MASS")
#installed.packages("caret")
library(MASS) 
library(caret)
library(leaps)

# Ensure 'stress_play' is always included in the model
force_var <- "stress_play"
force_in_vector <- rep(FALSE, 28)  # Assuming 28 variables as in your output
names(force_in_vector) <- colnames(full_data_exp1)  # Make sure this matches your data structure
force_in_vector["stress_play"] <- TRUE
# Exclude the response and the forced variable from the predictors
predictors <- setdiff(names(full_data_exp1), c("proportion_o_looks", force_var))

# Create the formula ensuring 'stress_play' is always included
formula_interactions <- as.formula(paste("proportion_o_looks ~ stress_play + (", force_var, "+", paste(predictors, collapse = "+"), ")^2"))
formula_interactions

subset_fit <- regsubsets(formula_interactions, data = full_data_exp1, nbest = 1, nvmax = 10, force.in = force_in_vector)

# Perform subset selection allowing other variables to vary
subset_fit <- regsubsets(formula_interactions, data = full_data_exp1, nbest = 1, nvmax = 10)
subset_summary <- summary(subset_fit)
subset_summary

# Print summary statistics
subset_summary$adjr2
subset_summary$cp
subset_summary$bic

# Choose a model based on BIC
selected_model <- which.min(subset_summary$bic)
subset_summary$which[selected_model, ]

# Cross-validation to check model performance
fit_control <- trainControl(method = "cv", number = 10)  # 10-fold cross-validation
fit_control
# Ensure 'stress_play' is included in the cross-validation model formula
model_formula <- as.formula(paste("proportion_o_looks ~", force_var, "+", paste(names(full_data_exp1)[subset_summary$which[selected_model,]], collapse = "+")))
model_cv <- train(model_formula, data = full_data_exp1, method = "lm", trControl = fit_control)
print(model_cv)
```

```{r}

m1<-lm(proportion_o_looks~(.)^2,data=full_data_exp1)
summary(m1)

included_predictors <- names(subset_summary$which[selected_model, ][subset_summary$which[selected_model, ] & names(subset_summary$which[selected_model, ]) != "(Intercept)"])

formula_str <- "proportion_o_looks ~"
formula_str <- paste(formula_str, paste(included_predictors, collapse = " + "), sep = "")
formula_str

formula_str <- gsub("Penultimate", "", formula_str, perl = TRUE)
model_formula <- as.formula(formula_str)
model_lm <- lm(model_formula, data = ets_exp1_all_agg_part_wider)

# Display the summary of the model
summary(model_lm)

check_model(m1)
check_model(model_lm)
```
```{r}

coef_df <- summary(model_lm)$coefficients

coef_df <- as.data.frame(coef_df)
coef_df$Predictor <- rownames(coef_df)
rownames(coef_df) <- NULL

ci_level <- 1.96
coef_df$CI_Lower <- coef_df$Estimate - ci_level * coef_df$`Std. Error`
coef_df$CI_Upper <- coef_df$Estimate + ci_level * coef_df$`Std. Error`


ggplot(coef_df, aes(x = Predictor, y = Estimate, ymin = CI_Lower, ymax = CI_Upper)) +
  geom_pointrange() +
  geom_hline(yintercept = 0, linetype = "dashed", color = "red") +
  labs(title = "Effect Sizes and Confidence Intervals for Model Coefficients",
       x = "Predictors",
       y = "Estimate") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))+coord_flip()+theme_bw()
```


```{r}

s_exp2_cleaned<-s_exp2%>%
  select(participant.private.id,spreadsheet.row,randomise_trials,display,randomise_trials,response,reaction.time,
         zone.type,display,q1,q2,q3,q4,target,competitor,distractor,distractor_1,audio)%>%
  filter(zone.type=="response_button_image")%>%
  #filter(display=="test_3_5")%>%
  mutate(
    split_parts = str_split(audio, "_"),
    word_audio = sapply(split_parts, function(x) x[2]),
    stress_audio = sapply(split_parts, function(x) x[3]),
    audio_word_stress=paste(word_audio,stress_audio,sep="_")
  ) %>%
  select(-split_parts)%>%
  mutate(
    split_parts = str_split(response, "_"),
    word_response = sapply(split_parts, function(x) x[2]),
    stress_response = sapply(split_parts, function(x) x[3]),
    response_word_stress=paste(word_response,stress_response,sep="_")
  ) %>%
  select(-split_parts)%>%
  mutate(correct=if_else(response_word_stress==audio_word_stress,1,0))%>%
  mutate(randomise_trials=if_else(randomise_trials<=5,5,randomise_trials))%>%
  mutate(stress_response=if_else(stress_response==1,"antipenultimate","penultimate"),
         stress_audio=if_else(stress_audio==1,"antipenultimate","penultimate"))


s_exp2_part<-s_exp2_cleaned%>%
  #filter(reaction.time<5000&reaction.time>1000)%>%
  filter(participant.private.id%in%s_exp2_cleaned$participant.private.id)

s_exp2_part%>%
  ggplot(aes(x=factor(participant.private.id),y=reaction.time,alpha=.5))+
  geom_jitter()

s_exp2_part<-s_exp2_part%>%
  group_by(participant.private.id)%>%
  mutate(log_rt=sqrt(reaction.time),
         participant_medians = median(log_rt))%>%
  ungroup()%>%
  mutate(medians_rt = median(log_rt),
         abs_distance = abs(log_rt-medians_rt),
         mean_distance = mean(abs_distance),
         upper_mad = medians_rt+(mean_distance*mad_standard),
         lower_mad = medians_rt-(mean_distance*mad_standard))%>%
  dplyr::filter(log_rt<upper_mad &log_rt>lower_mad)%>%
  dplyr::filter(participant_medians<upper_mad &participant_medians>lower_mad)

s_exp2_part%>%
  ggplot(aes(x=factor(participant.private.id),y=log_rt,alpha=.5))+
  geom_jitter()+
  geom_point(aes(x=factor(participant.private.id),y=participant_medians,alpha=.5),color="blue")+
  geom_point(aes(x=factor(participant.private.id),y=lower_mad,alpha=.5),color="red")+
  geom_point(aes(x=factor(participant.private.id),y=upper_mad,alpha=.5),color="red")
    
```


```{r}
s_exp2_agg<-s_exp2_cleaned%>%
  group_by(participant.private.id,randomise_trials,stress_audio)%>%
  summarize(score=mean(correct))

s_exp2_agg%>%ggplot(aes(x=factor(randomise_trials),y=score,color=factor(stress_audio),group=interaction(participant.private.id,factor(stress_audio))))+
  geom_line()+
  geom_point(position = "identity")+
  facet_wrap(factor(stress_audio)~.)
 
s_exp2_agg2<-s_exp2_cleaned%>%
  group_by(participant.private.id,randomise_trials)%>%
  summarize(score=mean(correct))

s_exp2_agg_means<-s_exp2_agg2%>%
  ungroup()%>%
  group_by(randomise_trials)%>%
  summarize(mean=mean(score),
            sd=sd(score))


View(s_exp2_agg_means)
s_exp2_agg2%>%ggplot(aes(x=factor(randomise_trials),y=score,color=factor(randomise_trials)))+
  geom_boxplot()+
  geom_jitter()+
  stat_summary(fun = mean, geom = "point", shape = 20, size = 3, color = "black") +  # Add mean points
  labs(x = "Randomise Trials", y = "Score", color = "Trial Number") +  # Label the axes and legend
  theme_minimal()
  
```




```{r}
s_exp2_et_cleaned<-s_exp2_et%>%
  select(participant_id,spreadsheet_row,type,time_stamp,
         time_elapsed,x_pred_normalised,y_pred_normalised,face_conf)%>%
  mutate(participant.private.id=participant_id,
         spreadsheet.row=spreadsheet_row)%>%
  select(!c(participant_id,spreadsheet_row))%>%
  filter(type=="prediction")	

s_exp2_cleaned_corr<-s_exp2_cleaned%>%filter(correct==1)

s_exp2_data_all<-s_exp2_et_cleaned%>%
  right_join(s_exp2_cleaned_corr)%>%
  na.omit()%>%
  filter(face_conf>.5)%>%
  mutate(x_pred_normalised=x_pred_normalised-.5,
         y_pred_normalised=y_pred_normalised-.5)%>%
  filter(x_pred_normalised<1&x_pred_normalised>-1)%>%
  filter(y_pred_normalised<1&y_pred_normalised>-1)%>%
  mutate(current_quadrant = case_when(
            x_pred_normalised < origin[1] & y_pred_normalised > origin[2] ~ q1,
            x_pred_normalised > origin[1] & y_pred_normalised > origin[2] ~ q2,
            x_pred_normalised < origin[1] & y_pred_normalised < origin[2] ~ q3,
            x_pred_normalised > origin[1] & y_pred_normalised < origin[2] ~ q4))%>%
  mutate(target_looks=if_else(current_quadrant==target,1,0),
         competitor_looks=if_else(current_quadrant==competitor,1,0),
         dist1_looks=if_else(current_quadrant==distractor_1,1,0),
         dist2_looks=if_else(current_quadrant==distractor,1,0))%>%
  mutate(dist1_looks=if_else(randomise_trials%in% c(2, 3, 4, 5, 7, 11),NA,dist1_looks),
         dist2_looks=if_else(randomise_trials%in% c(2, 3, 4, 5, 7, 11),NA,dist2_looks))%>%
  group_by(participant.private.id,spreadsheet.row,stress_audio)%>%
  mutate(time=time_stamp-min(time_stamp),
         time_rounded = round(time / 50) * 50)%>%
  mutate(time_rounded=time_rounded-1000)%>%
  filter(time_rounded<1500&time_rounded>0)%>%
  filter((randomise_trials %in% c(9, 13)) | # Keep all cases where randomise_trials is 9 or 13
         (randomise_trials %in% c(2, 3, 4, 5, 7, 11) & y_pred_normalised >= 0))

ets_exp2_all_agg<-s_exp2_data_all%>%
  group_by(stress_audio,time_rounded,randomise_trials)%>%
  summarise(mean_target_looks=mean(target_looks),
            mean_competitor_looks=mean(competitor_looks),
            mean_dist1_looks=mean(dist1_looks),
            mean_dist2_looks=mean(dist2_looks))%>%
  ungroup()%>%
  pivot_longer(cols=c(mean_target_looks:mean_dist2_looks),names_to = "names",values_to="values")
  
ets_exp2_all_agg%>%
  ggplot(aes(x=time_rounded,y=values,color=names))+
  geom_point()+
  geom_smooth()+
  facet_grid(factor(stress_audio)~factor(randomise_trials))

ets_exp2_all_agg_part<-s_exp2_data_all%>%
  filter(time_rounded<800&time_rounded>0)%>%
  group_by(stress_audio,participant.private.id,randomise_trials)%>%
  summarise(mean_target_looks=mean(target_looks),
            mean_competitor_looks=mean(competitor_looks),
            mean_dist1_looks=mean(dist1_looks),
            mean_dist2_looks=mean(dist2_looks))%>%
  ungroup()%>%
  pivot_longer(cols=c(mean_target_looks:mean_dist2_looks),names_to = "names",values_to="values")
  

ets_exp2_all_agg_part%>%
  ggplot(aes(x=factor(participant.private.id),y=values,color=names))+
  geom_point()+
  geom_smooth()+
  facet_grid(stress_audio~randomise_trials)+
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))


```

```{r}
ets_exp2_all_agg_part_wider<-ets_exp2_all_agg_part%>%
  pivot_wider(names_from = names,values_from = values)%>%
  mutate(proportion_o_looks=mean_target_looks-mean_competitor_looks)%>%
  left_join(battery_agg_wider_simp)%>%
  left_join(digit_cleaned_simp)%>%
  left_join(lextale_agg_cleaned_simp)%>%
  left_join(italian_lextale_agg_cleaned_simp)%>%
  left_join(autism_cleaned)


ets_exp2_all_agg_part_wider%>%
  ggplot(aes(x=stress_audio,y=proportion_o_looks,color=stress_audio))+
  geom_boxplot()+
  geom_jitter()+
  facet_grid(.~randomise_trials)+
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))
full_data_exp2<-ets_exp2_all_agg_part_wider%>%
  select(!c(participant.private.id,c_battery_up_dur:c_battery_up_risetime,
            mean_target_looks:mean_dist2_looks))
full_data_exp2$randomise_trials<-as.factor(full_data_exp2$randomise_trials)
ggpairs(full_data_exp2)
```

```{r message=FALSE, warning=FALSE}
force_var <- "stress_audio"
force_in_vector
force_in_vector <- rep(FALSE,28)  # Assuming 28 variables as in your output
names(force_in_vector) <- colnames(full_data_exp2)  # Make sure this matches your data structure
force_in_vector["stress_play"] <- TRUE
# Exclude the response and the forced variable from the predictors
predictors <- setdiff(names(full_data_exp2), c("proportion_o_looks", force_var))

# Create the formula ensuring 'stress_play' is always included
formula_interactions <- as.formula(paste("proportion_o_looks ~ (", force_var, "+", paste(predictors, collapse = "+"), ")^2"))
formula_interactions

subset_fit <- regsubsets(formula_interactions, data = full_data_exp2, nbest = 1, nvmax = 10, force.in = force_in_vector,really.big=T)

subset_summary <- summary(subset_fit)
subset_summary

# Print summary statistics
subset_summary$adjr2
subset_summary$cp
subset_summary$bic

# Choose a model based on BIC
selected_model <- which.min(subset_summary$bic)
subset_summary$which[selected_model, ]

# Cross-validation to check model performance
fit_control <- trainControl(method = "cv", number = 10)  # 10-fold cross-validation
fit_control
```

```{r}
included_predictors <- names(subset_summary$which[selected_model, ][subset_summary$which[selected_model, ] & names(subset_summary$which[selected_model, ]) != "(Intercept)"])

formula_str <- "proportion_o_looks ~"
formula_str <- paste(formula_str, paste(included_predictors, collapse = " + "), sep = "")
formula_str

formula_str <- gsub("penultimate", "", formula_str, perl = TRUE)
formula_str <- gsub("13", "", formula_str, perl = TRUE)
formula_str <- gsub("11", "", formula_str, perl = TRUE)
formula_str <- gsub("7", "", formula_str, perl = TRUE)
model_formula <- as.formula(formula_str)
model_lm2 <- lm(model_formula, data = ets_exp2_all_agg_part_wider)

# Display the summary of the model
summary(model_lm2)

check_model(m1)
check_model(model_lm)
```

```{r}
coef_df2 <- summary(model_lm2)$coefficients

coef_df2 <- as.data.frame(coef_df2)
coef_df2$Predictor <- rownames(coef_df2)
rownames(coef_df2) <- NULL

ci_level <- 1.96
coef_df2$CI_Lower <- coef_df2$Estimate - ci_level * coef_df2$`Std. Error`
coef_df2$CI_Upper <- coef_df2$Estimate + ci_level * coef_df2$`Std. Error`


ggplot(coef_df2, aes(x = Predictor, y = Estimate, ymin = CI_Lower, ymax = CI_Upper)) +
  geom_pointrange() +
  geom_hline(yintercept = 0, linetype = "dashed", color = "red") +
  labs(title = "Effect Sizes and Confidence Intervals for Model Coefficients",
       x = "Predictors",
       y = "Estimate") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))+coord_flip()+theme_bw()
```
